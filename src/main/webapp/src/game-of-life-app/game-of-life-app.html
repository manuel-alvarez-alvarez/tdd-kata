<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="stylesheet" href="../../bower_components/semantic/dist/semantic.min.css">
<script src="../../bower_components/three.js/build/Three.js"></script>
<script src="../../bower_components/jquery/dist/jquery.min.js"></script>
<script src="../../bower_components/semantic/dist/semantic.min.js"></script>

<link rel="import" href="game-of-life-field.html">


<dom-module id="game-of-life-app">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>

        <iron-ajax id="ajax" method="GET" content-type="text/plain" url="/service" handle-as="json"
                   on-response="_onServices"></iron-ajax>

        <div id="container">
            <game-of-life-field cells="{{cells}}"/>
        </div>

    </template>

    <script>
        Polymer({
            is: 'game-of-life-app',

            properties: {
                cells: {
                    type: String
                }
            },

            ready: function () {
                this.scopeSubtree(this.$.container, true);
                this._fetchServices(this)();
            },

            _fetchServices: function (self) {
                return function() {
                    self.$.ajax.body = atob(self.cells);
                    self.$.ajax.generateRequest();
                    setTimeout(self._fetchServices(self), 1000);
                };
            },

            _onServices: function (e, detail) {
                var field, i;
                var services = detail.xhr.response;
                var root = Polymer.dom(this.root);
                var fields = root.querySelectorAll("game-of-life-field");
                var fieldMap = {};
                for (i in fields) {
                    field = fields[i];
                    var id = field.getAttribute("service-id");
                    if (id) {
                        fieldMap[id] = field;
                    }
                }
                for (i in services) {
                    var serviceId = services[i];
                    field = fieldMap[id];
                    if (!field) {
                        field = document.createElement("game-of-life-field");
                        field.setAttribute("service-id", serviceId);
                        field.setAttribute("cells", this.cells);
                        root.appendChild(field);
                    } else {
                        delete fieldMap[serviceId];
                    }
                }
                for (field in fieldMap) {
                    root.removeChild(fieldMap[field]);
                }
            }
        });
    </script>
</dom-module>
