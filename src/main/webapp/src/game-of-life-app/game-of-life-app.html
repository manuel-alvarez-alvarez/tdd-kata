<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="game-of-life-field.html">


<dom-module id="game-of-life-app">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>

        <iron-ajax id="ajax" method="GET" content-type="text/plain" url="/service" handle-as="json" on-response="_onServices"></iron-ajax>

        <game-of-life-field cells="{{cells}}" />

    </template>

    <script>
        Polymer({
            is: 'game-of-life-app',

            properties: {
                cells: {
                    type: String
                }
            },

            ready: function () {
                this._fetchServices();
            },

            _fetchServices: function () {
                this.$.ajax.body = atob(this.cells);
                this.$.ajax.generateRequest();
            },

            _onServices: function (e, detail) {
                var field, i;
                var services = detail.xhr.response;
                var root = Polymer.dom(this.root);
                var fields = root.querySelectorAll("game-of-life-field");
                for (i in fields) {
                    field = fields[i];
                    var id = field.getAttribute("service-id");
                    if (id) {
                        if (!data.hasOwnProperty(id)) {
                            delete data[id];
                        } else {
                            root.removeChild(field);
                        }
                    }
                }
                for (var serviceId in services) {
                    field = document.createElement("game-of-life-field");
                    this._populateField(field, serviceId, data[serviceId]);
                    root.appendChild(field);
                }
            },

            _populateField: function (field, id, data) {
                field.setAttribute("service-id", id);
                field.setAttribute("error", data.error ? "true" : false);
                if (!data.error) {
                    field.setAttribute("cells", btoa(data));
                }
            }
        });
    </script>
</dom-module>
