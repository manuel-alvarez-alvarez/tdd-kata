<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="game-of-life-field">
    <template>
        <style>
            :host {
                display: block;
            }

            .container {
                background-color: #808080;
                border: 1px solid white;
            }

        </style>

        <iron-ajax id="ajax" method="POST" content-type="text/plain" url="/service" handle-as="json"
                   on-response="_onNextGenerations"
                   on-error="_onError"></iron-ajax>

        {{serviceId}}
        {{error}}

        <div id="container" class$="{{_getClass()}}"></div>

    </template>

    <script>
        Polymer({

            is: 'game-of-life-field',

            properties: {

                serviceId: {
                    type: String
                },

                cells: {
                    type: String
                },

                cubeSize: {
                    type: Number,
                    value: 20
                },

                frames: {
                    type: Number,
                    value: 100
                },

                error: {
                    type: Boolean,
                    value: false
                }
            },

            attached: function () {
                this.current = atob(this.cells);
                this.next = [];
                this._parseGeneration();
                this._buildScene();
                this._initializeCubes();
                this._cubesLoop(this)();
                this._animate(this)();
            },

            destroy: function () {

            },

            _getClass: function() {
              return "container " + (this.error ? "error" : "");
            },

            _parseGeneration: function () {
                this.generation = [];
                var array = this.current.split("\n");
                for (var i in array) {
                    this.generation[i] = array[i].trim().split("");
                }
                this.rows = this.generation.length;
                this.cols = this.generation[0].length;
            },

            _buildScene: function () {
                this.container = this.$.container;
                var w = this.cols * this.cubeSize;
                var h = this.rows * this.cubeSize;
                this.container.style.width = w + 'px';
                this.container.style.height = h + 'px';

                this.scene = new THREE.Scene();

                // Camera.

                var z = Math.min(w, h);
                var fov = 2 * Math.atan(h / (2 * z));
                this.camera = new THREE.PerspectiveCamera(fov * 180 / Math.PI, w / h, 1, 10000);
                this.camera_x = 0;
                this.camera_y = 0;
                this.camera_z = z + this.cubeSize;
                this.cameraTarget = new THREE.Vector3(0, 0, 0);
                this.camera.position.y = this.camera_y;
                this.camera.position.z = this.camera_z;
                this.camera.position.x = this.camera_x;
                this.camera.lookAt(this.cameraTarget);

                this.scene.add(this.camera);

                // Plane.
                this.plane = new THREE.Mesh(
                        new THREE.PlaneGeometry(this.cols * this.cubeSize, this.rows * this.cubeSize, this.cols, this.rows),
                        new THREE.MeshBasicMaterial({ color: 0x999999, wireframe: true }));

                this.plane.rotation.x = Math.PI / 2;

                this.scene.add(this.plane);

                // Renderer.
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(w, h);
                this.container.appendChild(this.renderer.domElement);
            },

            _initializeCubes: function () {
                this.cubeGeo = new THREE.CubeGeometry(this.cubeSize, this.cubeSize, this.cubeSize);
                this.cubeMaterial = new THREE.MeshBasicMaterial({
                    shading: THREE.FlatShading,
                    map: THREE.ImageUtils.loadTexture("/images/square-outline.png")
                });
                this.cubeMaterial.color.setHex(0xffff00);
                this.cubeMaterial.ambient = this.cubeMaterial.color;
                this.cubesPool = [];
                this.liveCubes = this._matrix(this.rows, this.cols);
            },

            _buildCube: function () {
                var cube = new THREE.Mesh(this.cubeGeo, this.cubeMaterial);
                cube.visible = false;
                this.scene.add(cube);
                return cube;
            },

            _matrix: function (rows, columns) {
                var grid = new Array(rows);
                for (var i = 0; i < rows; i++) {
                    grid[i] = new Array(columns);
                }
                return grid;
            },

            _cubesLoop: function (self) {
                return function () {
                    for (var y in self.generation) {
                        for (var x in self.generation[y]) {
                            switch (self.generation[y][x]) {
                                case ".":
                                    self._killCell([y, x]);
                                    break;
                                case "O":
                                    self._drawCell([y, x]);
                                    break;
                            }
                        }
                    }
                    if (self.next.length < self.frames / 2 && !self.$.ajax.loading) {
                        self.$.ajax.url = "/service/" + (self.serviceId !== undefined ? btoa(self.serviceId) : "");
                        self.$.ajax.body = self.current;
                        self.$.ajax.params = { frames: self.frames };
                        self.$.ajax.generateRequest();
                    }
                    if (self.next.length > 0) {
                        self.current = self.next.shift();
                        self._parseGeneration();
                    }
                    setTimeout(self._cubesLoop(self), 100);
                };
            },

            _animate: function (self) {
                return function () {
                    requestAnimationFrame(self._animate(self));
                    self._render();
                };

            },

            _render: function () {
                this.renderer.render(this.scene, this.camera);
            },

            _getCube: function () {
                return this.cubesPool.shift() || this._buildCube();
            },

            _drawCell: function (coords) {
                var cube = this.liveCubes[coords[0]][coords[1]];
                if (cube === undefined) {
                    cube = this._getCube();
                    cube.position.x = (coords[1] - this.cols / 2) * this.cubeSize + this.cubeSize / 2;
                    cube.position.y = (this.rows / 2 - coords[0]) * this.cubeSize - this.cubeSize / 2;
                    cube.position.z = 10;
                    cube.visible = true;
                    this.liveCubes[coords[0]][coords[1]] = cube;
                }
            },

            _killCell: function (coords) {
                var cube = this.liveCubes[coords[0]][coords[1]];
                if (cube !== undefined) {
                    cube.visible = false;
                    this.liveCubes[coords[0]][coords[1]] = undefined;
                    this.cubesPool.push(cube);
                }
            },

            _onNextGenerations: function (e, data) {
                var response = data.xhr.response;
                for (var i in response.right) {
                    this.next.push(response.right[i]);
                }
                this.error = false;
            },

            _onError: function(e, data) {
                this.error = true;
            }


        });
    </script>
</dom-module>
